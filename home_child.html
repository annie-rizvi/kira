<!DOCTYPE html>
<html>
<body onload = "welcome()">

<h1>Kira</h1>
<div>
    <h2 id = "total_points"></h2>
    <div>
        <h2>Weekly Schedule</h2>
        <table onchange = changeProgress()>
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Description</th>
                    <th>Points</th>
                    <th>Progress</th>
                    <th> </th>
                  </tr>
            </thead>
            <tbody id="schedule_body">
            </tbody>
          </table>
    </div>
    <div>
        <button onclick="clearStorage()">Clear</button>
    </div>
    
</div>

</body>
</html>

<script>
    class Task{
        constructor(n, d, p) {
            this.name = n;
            this.description = d;
            this.points = p;
        }
    }
    class ScheduleItem{
        constructor(task, child) {
            this.task = task;
            this.child = child;
            this.progress = false;
        }
    }

    class Child{
        constructor(n, p, points) {
            this.username = n;
            this.password = p;
            this.points = points;
        }
    }
    var total_points=0;
    let child_name = window.localStorage.getItem("current_child");
    function welcome() {
        
        let schedule = JSON.parse(window.localStorage.getItem("schedule"));
        let children = JSON.parse(window.localStorage.getItem("children"));
        console.log(children);
        for(let i=0; i<children.length; i++)
        {
            if(child_name == children[i].username)
            {
                total_points = Number(children[i].points);
            }
        }
        console.log(total_points);
        document.getElementById("total_points").innerHTML = "You have " + total_points + " Points!";
        let tasks = JSON.parse(window.localStorage.getItem("tasks"));
        console.log(child_name);
        console.log(schedule);
        console.log(tasks);
        let length = schedule.length;
        const table = document.getElementById("schedule_body");
        for(let i=0; i<length; i++)
        {
            let item = schedule[i];
            if(item.child == child_name)
            {   
                let row = table.insertRow();
                let task = row.insertCell(0);
                task.innerHTML = item.task;
                let description = row.insertCell(1);
                let points = row.insertCell(2);
                for(let j=0; j< tasks.length; j++)
                {
                       if(tasks[j].name == item.task)
                       {
                           description.innerHTML = tasks[j].description;
                            points.innerHTML = tasks[j].points;
                            break;
                       }
                }
                let progress = row.insertCell(3);
                if(item.progress)
                {
                    progress.innerHTML = "Completed";
                }
                else
                {
                    progress.innerHTML = "Not Completed";
                }
                let check = row.insertCell(4);
                var checkbox = document.createElement('input');
                checkbox.id = String(i-2)+"checkbox";
                console.log(checkbox.id);
                checkbox.type = "checkbox";
                checkbox.checked = item.progress;
                check.appendChild(checkbox);
                
            }
        }

       

    }

    function changeProgress() {

            console.log("clicked");
            let schedule = JSON.parse(window.localStorage.getItem("schedule"));
            let length = schedule.length;
            const table = document.getElementById("schedule_body");
            for(let i=0; i< table.childNodes.length-1; i++)
            {
                for(let j=0; j< length; j++)
                {
                    if(table.childNodes[i+1].childNodes[0].innerHTML == schedule[j].task)
                    {
                        schedule[j].progress = document.getElementById(String(i)+"checkbox").checked;
                    }
                }
                if(document.getElementById(String(i)+"checkbox").checked && table.childNodes[i+1].childNodes[3].innerHTML == "Not Completed")
                {
                    total_points += Number(table.childNodes[i+1].childNodes[2].innerHTML);

                }
                else if(!document.getElementById(String(i)+"checkbox").checked && table.childNodes[i+1].childNodes[3].innerHTML == "Completed")
                {
                    total_points -= Number(table.childNodes[i+1].childNodes[2].innerHTML);
                }
                if(document.getElementById(String(i)+"checkbox").checked)
                {
                    table.childNodes[i+1].childNodes[3].innerHTML = "Completed";
                }
                else
                {
                    table.childNodes[i+1].childNodes[3].innerHTML = "Not Completed";
                }
                
                window.localStorage.setItem("schedule", JSON.stringify(schedule));
                let children = JSON.parse(window.localStorage.getItem("children"));
                console.log(children);
                console.log(child_name);
                document.getElementById("total_points").innerHTML = "You have " + total_points + " Points!";
                for(let i=0; i<children.length; i++)
                {
                    if(child_name == children[i].username)
                    {
                        
                        children[i].points = String(total_points);
                        console.log("changed");
                    }
                }
                console.log(children);
                window.localStorage.setItem("children", JSON.stringify(children));
                console.log(JSON.parse(window.localStorage.getItem("children")));

            }
        }
        function clearStorage() {
            window.localStorage.removeItem("children");
        }
</script> 